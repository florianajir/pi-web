name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  lint:
    name: Lint and Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Validate Docker Compose files
        run: |
          docker compose -f compose.yaml config
          docker compose -f compose.yaml -f compose.test.yaml config

      - name: Lint YAML files
        run: |
          pip install yamllint
          yamllint -c .yamllint .

      - name: Validate Prometheus config
        run: |
          # Align path with repository layout (see config/prometheus/)
          if [ -f config/prometheus/prometheus.yml ]; then
            PROM_DIR=config/prometheus
          else
            echo "âŒ prometheus.yml not found in expected paths" >&2
            exit 1
          fi
          # Use pinned Prometheus image version to ensure deterministic promtool
          docker run --rm \
            -v "$PWD/$PROM_DIR":/etc/prometheus:ro \
            --entrypoint=promtool \
            prom/prometheus:v2.51.0 \
            check config /etc/prometheus/prometheus.yml

      - name: Validate Prometheus rule files (if any)
        run: |
          set -e
          if ls config/prometheus/*rules*.yml >/dev/null 2>&1; then
            echo "ðŸ” Validating rule files"
            for f in config/prometheus/*rules*.yml; do
              echo " - $f";
              docker run --rm \
                -v "$PWD/config/prometheus":/etc/prometheus:ro \
                --entrypoint=promtool \
                prom/prometheus:v2.51.0 \
                check rules "/etc/prometheus/$(basename "$f")";
            done
          else
            echo "(No Prometheus rule files present to validate)"
          fi

      - name: Check Makefile syntax
        run: |
          make help > /dev/null

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"
        continue-on-error: true

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always() && github.repository_owner == github.actor
        with:
          sarif_file: "trivy-results.sarif"
        continue-on-error: true

      - name: Upload Trivy results as artifact
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: trivy-results
          path: trivy-results.sarif
          retention-days: 30

      - name: Security checks
        run: |
          echo "ðŸ” Running security checks..."

          # Check Docker Compose configurations
          for file in */compose.yaml; do
            echo "Checking $file..."
            grep -q "privileged.*true" "$file" && echo "âš ï¸ WARNING: Privileged container in $file"
            grep -q "network_mode.*host" "$file" && echo "âš ï¸ WARNING: Host network mode in $file"
            grep -q "/etc:" "$file" && echo "âš ï¸ WARNING: Bind mount to /etc in $file"
            grep -q "restart:" "$file" || echo "â„¹ï¸ INFO: No restart policy in $file"
          done

          echo "âœ… Security checks completed"

  test-deployment:
    name: Test Deployment
    runs-on: ubuntu-latest
    env:
      HOST_NAME: test.local
      USER: testuser
      EMAIL: test@example.com
      PASSWORD: testpassword123
      HOST_IP: 192.168.1.100

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Test all services deployment
        run: |
          # Create test environment
          echo "HOST_NAME=test.local" > .env
          echo "USER=testuser" >> .env
          echo "EMAIL=test@example.com" >> .env
          echo "PASSWORD=testpassword123" >> .env

          # Use compose.test.yaml to override problematic port bindings
          docker compose -f compose.yaml -f compose.test.yaml up -d
          sleep 15
          docker compose -f compose.yaml -f compose.test.yaml ps

          # Verify key services are running
          docker compose -f compose.yaml -f compose.test.yaml exec -T traefik wget -q --spider http://localhost:8080/api/entrypoints || echo "Traefik API not ready"
          docker compose -f compose.yaml -f compose.test.yaml exec -T grafana wget -q --spider http://localhost:3000/api/health || echo "Grafana not ready"
          docker compose -f compose.yaml -f compose.test.yaml exec -T prometheus wget -q --spider http://localhost:9090/-/healthy || echo "Prometheus not ready"

          # Lightweight HTTPS smoke test against Traefik (self-signed / internal). Skips certificate validation.
          # Uses --resolve to map host to loopback since we don't have DNS in CI.
          curl -sk --resolve "traefik.test.local:443:127.0.0.1" https://traefik.test.local/ >/dev/null || echo "Traefik HTTPS smoke test failed"

          docker compose -f compose.yaml -f compose.test.yaml down

  build-and-push:
    name: Build and Push Documentation
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [lint, security, test-deployment]
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Generate documentation
        run: |
          cat > docs.md << EOF
          # pi-web build status

          Last build: $(date)
          EOF

      - name: Deploy documentation to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          destination_dir: docs
